<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ships - SERVER</a> &gt; <a href="index.source.html" class="el_package">com.epam.ships.server</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package com.epam.ships.server;

import com.epam.ships.fleet.Damage;
import com.epam.ships.fleet.Fleet;
import com.epam.ships.fleet.Mast;
import com.epam.ships.infra.communication.api.Message;
import com.epam.ships.infra.communication.api.message.Author;
import com.epam.ships.infra.communication.api.message.Header;
import com.epam.ships.infra.communication.api.message.Status;
import com.epam.ships.infra.communication.core.message.MessageBuilder;
import com.epam.ships.infra.logging.api.Target;
import com.epam.ships.infra.logging.core.SharedLogger;

/**
 * * It starts a communication bus
 * and receives messages from it.
 * @author Piotr Czy≈º
 * @since 2017-12-09
 */
class Game {

  private final CommunicationBus communicationBus;
<span class="nc" id="L23">  private final Target logger = new SharedLogger(Game.class);</span>
  private final TurnManager turnManager;
  private Fleet firstPlayerFleet;
  private Fleet secondPlayerFleet;

<span class="nc" id="L28">  Game(CommunicationBus communicationBus) {</span>
<span class="nc" id="L29">    this.communicationBus = communicationBus;</span>
<span class="nc" id="L30">    this.turnManager = new TurnManager(communicationBus.getFirstClient(),</span>
<span class="nc" id="L31">        communicationBus.getSecondClient());</span>
<span class="nc" id="L32">  }</span>

  void play() {
<span class="nc" id="L35">    this.notifyPlayersThatTheyCanStartGame();</span>
<span class="nc" id="L36">    this.askPlayersForPlaceFleet();</span>
<span class="nc" id="L37">    this.receiveFleetFromBothPlayers();</span>
<span class="nc" id="L38">    this.rest();</span>
<span class="nc" id="L39">    this.sendYourTurnMessage();</span>
<span class="nc" id="L40">    boolean isClientConnected = true;</span>
<span class="nc" id="L41">    boolean isGameFinished = false;</span>
<span class="nc bnc" id="L42" title="All 4 branches missed.">    while (!isGameFinished &amp;&amp; isClientConnected) {</span>
<span class="nc" id="L43">      Message receivedShot = this.receiveShot();</span>
<span class="nc" id="L44">      isClientConnected = this.isClientConnected(receivedShot);</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">      if (isClientConnected) {</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (this.turnManager.isCurrentPlayerFirstPlayer()) {</span>
<span class="nc" id="L47">          isGameFinished = this.handleShot(receivedShot, secondPlayerFleet);</span>
        } else {
<span class="nc" id="L49">          isGameFinished = this.handleShot(receivedShot, firstPlayerFleet);</span>
        }
      }
<span class="nc bnc" id="L52" title="All 2 branches missed.">      if (isGameFinished) {</span>
<span class="nc" id="L53">        this.handleEndOfGame();</span>
      }
<span class="nc" id="L55">      this.rest();</span>
<span class="nc" id="L56">    }</span>
<span class="nc" id="L57">  }</span>

  private boolean handleShot(Message receivedShot, Fleet fleet) {
<span class="nc" id="L60">    final Mast mast = Mast.ofIndex(receivedShot.getStatement());</span>
<span class="nc" id="L61">    logger.debug(receivedShot.getStatement());</span>
<span class="nc" id="L62">    Damage damage = fleet.handleDamage(mast);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">    if (damage.equals(Damage.MISSED)) {</span>
<span class="nc" id="L64">      logger.debug(&quot;got here: missed&quot;);</span>
<span class="nc" id="L65">      this.handleMiss(receivedShot);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">    } else if (damage.equals(Damage.HIT)) {</span>
<span class="nc" id="L67">      logger.debug(&quot;got here: hit&quot;);</span>
<span class="nc" id="L68">      this.handleHit(receivedShot);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">    } else if (damage.equals(Damage.DESTRUCTED)) {</span>
<span class="nc" id="L70">      logger.debug(&quot;got here: destructed&quot;);</span>
<span class="nc" id="L71">      this.handleDamageShot(receivedShot);</span>
    }
<span class="nc" id="L73">    return fleet.isDefeated();</span>
  }

  private void handleDamageShot(Message receivedShot) {
<span class="nc" id="L77">    this.sendShipDestructedMessage();</span>
<span class="nc" id="L78">    this.sendShotToOpponent(receivedShot);</span>
<span class="nc" id="L79">  }</span>

  private void handleEndOfGame() {
<span class="nc" id="L82">    this.sendWonMessage();</span>
<span class="nc" id="L83">    this.sendLostMessage();</span>
<span class="nc" id="L84">  }</span>

  private void sendWonMessage() {
<span class="nc" id="L87">    final Message won = new MessageBuilder()</span>
<span class="nc" id="L88">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L89">        .withHeader(Header.WIN)</span>
<span class="nc" id="L90">        .build();</span>
<span class="nc" id="L91">    this.communicationBus.send(turnManager.getCurrentPlayer(), won);</span>
<span class="nc" id="L92">  }</span>

  private void sendLostMessage() {
<span class="nc" id="L95">    final Message lost = new MessageBuilder()</span>
<span class="nc" id="L96">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L97">        .withHeader(Header.LOSE)</span>
<span class="nc" id="L98">        .build();</span>
<span class="nc" id="L99">    this.communicationBus.send(turnManager.getOtherPlayer(), lost);</span>
<span class="nc" id="L100">  }</span>

  private void sendShipDestructedMessage() {
<span class="nc" id="L103">    final Message hit = new MessageBuilder()</span>
<span class="nc" id="L104">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L105">        .withHeader(Header.SHIP_DESTRUCTED)</span>
<span class="nc" id="L106">        .build();</span>
<span class="nc" id="L107">    this.communicationBus.send(turnManager.getCurrentPlayer(), hit);</span>
<span class="nc" id="L108">  }</span>

  private void handleHit(Message receivedShot) {
<span class="nc" id="L111">    this.sendHitMessage();</span>
<span class="nc" id="L112">    this.sendShotToOpponent(receivedShot);</span>
<span class="nc" id="L113">  }</span>

  private void sendHitMessage() {
<span class="nc" id="L116">    final Message hit = new MessageBuilder()</span>
<span class="nc" id="L117">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L118">        .withHeader(Header.HIT)</span>
<span class="nc" id="L119">        .build();</span>
<span class="nc" id="L120">    this.communicationBus.send(turnManager.getCurrentPlayer(), hit);</span>
<span class="nc" id="L121">  }</span>

  private void handleMiss(Message receivedShot) {
<span class="nc" id="L124">    this.sendMissMessage();</span>
<span class="nc" id="L125">    this.sendShotToOpponent(receivedShot);</span>
<span class="nc" id="L126">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L127">    rest();</span>
<span class="nc" id="L128">    this.sendYourTurnMessage();</span>
<span class="nc" id="L129">  }</span>

  private void sendMissMessage() {
<span class="nc" id="L132">    final Message miss = new MessageBuilder()</span>
<span class="nc" id="L133">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L134">        .withHeader(Header.MISS)</span>
<span class="nc" id="L135">        .build();</span>
<span class="nc" id="L136">    this.communicationBus.send(turnManager.getCurrentPlayer(), miss);</span>
<span class="nc" id="L137">  }</span>

  private void receiveFleetFromBothPlayers() {
<span class="nc" id="L140">    this.firstPlayerFleet = this.receiveFloat();</span>
<span class="nc" id="L141">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L142">    this.secondPlayerFleet = this.receiveFloat();</span>
<span class="nc" id="L143">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L144">  }</span>

  private Fleet receiveFloat() {
<span class="nc" id="L147">    final Message fleet = this.communicationBus.receive(this.turnManager.getCurrentPlayer());</span>
<span class="nc" id="L148">    logger.info(&quot;Fleet received: &quot; + fleet);</span>
<span class="nc" id="L149">    return fleet.getFleet();</span>
  }

  private void askPlayersForPlaceFleet() {
<span class="nc" id="L153">    this.askForPlaceFleet();</span>
<span class="nc" id="L154">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L155">    this.askForPlaceFleet();</span>
<span class="nc" id="L156">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L157">  }</span>

  private void askForPlaceFleet() {
<span class="nc" id="L160">    final Message message = new MessageBuilder()</span>
<span class="nc" id="L161">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L162">        .withHeader(Header.PLACEMENT)</span>
<span class="nc" id="L163">        .build();</span>
<span class="nc" id="L164">    this.communicationBus.send(turnManager.getCurrentPlayer(), message);</span>
<span class="nc" id="L165">  }</span>

  private void sendShotToOpponent(Message receivedShot) {
<span class="nc" id="L168">    this.communicationBus.send(this.turnManager.getOtherPlayer(), receivedShot);</span>
<span class="nc" id="L169">    logger.info(&quot;Shot send&quot;);</span>
<span class="nc" id="L170">  }</span>

  private Message receiveShot() {
<span class="nc" id="L173">    final Message shot = this.communicationBus.receive(this.turnManager.getCurrentPlayer());</span>
<span class="nc" id="L174">    logger.info(shot);</span>
<span class="nc" id="L175">    return shot;</span>
  }

  private void sendYourTurnMessage() {
<span class="nc" id="L179">    final Message turn = new MessageBuilder()</span>
<span class="nc" id="L180">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L181">        .withHeader(Header.YOUR_TURN)</span>
<span class="nc" id="L182">        .build();</span>
<span class="nc" id="L183">    this.communicationBus.send(turnManager.getCurrentPlayer(), turn);</span>
<span class="nc" id="L184">    logger.info(&quot;send your turn&quot;);</span>
<span class="nc" id="L185">  }</span>

  private boolean isClientConnected(final Message messageReceived) {
<span class="nc" id="L188">    boolean isClientConnected = true;</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">    if (Header.CONNECTION.equals(messageReceived.getHeader())</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        &amp;&amp; Status.END.equals(messageReceived.getStatus())) {</span>
<span class="nc" id="L191">      isClientConnected = false;</span>
    }
<span class="nc" id="L193">    return isClientConnected;</span>
  }

  private void notifyPlayersThatTheyCanStartGame() {
<span class="nc" id="L197">    this.opponentConnected();</span>
<span class="nc" id="L198">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L199">    this.opponentConnected();</span>
<span class="nc" id="L200">    this.turnManager.switchPlayer();</span>
<span class="nc" id="L201">  }</span>

  private void opponentConnected() {
<span class="nc" id="L204">    final Message message = new MessageBuilder()</span>
<span class="nc" id="L205">        .withAuthor(Author.SERVER)</span>
<span class="nc" id="L206">        .withHeader(Header.OPPONENT_CONNECTED)</span>
<span class="nc" id="L207">        .withStatement(&quot;true&quot;)</span>
<span class="nc" id="L208">        .build();</span>
<span class="nc" id="L209">    this.communicationBus.send(this.turnManager.getCurrentPlayer(), message);</span>
<span class="nc" id="L210">  }</span>

  private void rest() {
<span class="nc" id="L213">    final long restTime = 300;</span>
    try {
<span class="nc" id="L215">      Thread.sleep(restTime);</span>
<span class="nc" id="L216">    } catch (final InterruptedException e) {</span>
<span class="nc" id="L217">      logger.error(e.getMessage());</span>
<span class="nc" id="L218">      Thread.currentThread().interrupt();</span>
<span class="nc" id="L219">    }</span>
<span class="nc" id="L220">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>