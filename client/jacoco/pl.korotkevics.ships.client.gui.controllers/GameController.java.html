<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ships - CLIENT</a> &gt; <a href="index.source.html" class="el_package">pl.korotkevics.ships.client.gui.controllers</a> &gt; <span class="el_source">GameController.java</span></div><h1>GameController.java</h1><pre class="source lang-java linenums">package pl.korotkevics.ships.client.gui.controllers;

import pl.korotkevics.ships.client.client.Client;
import pl.korotkevics.ships.client.gui.events.HitShotEvent;
import pl.korotkevics.ships.client.gui.events.LooseEvent;
import pl.korotkevics.ships.client.gui.events.MissShotEvent;
import pl.korotkevics.ships.client.gui.events.OpponentShotEvent;
import pl.korotkevics.ships.client.gui.events.OpponentWithdrawEvent;
import pl.korotkevics.ships.client.gui.events.TurnChangeEvent;
import pl.korotkevics.ships.client.gui.events.WinEvent;
import pl.korotkevics.ships.shared.infra.logging.api.Target;
import pl.korotkevics.ships.shared.infra.logging.core.SharedLogger;
import javafx.beans.binding.Bindings;
import javafx.beans.binding.NumberBinding;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.geometry.HPos;
import javafx.scene.Parent;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.GridPane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.stage.Stage;

import java.io.IOException;

/**
 * Game window controller.
 * @author Magdalena Aarsman
 * @since 2017-12-15
 */

<span class="nc" id="L36">public class GameController {</span>

<span class="nc" id="L38">  private static final Target logger = new SharedLogger(Client.class);</span>

  private static final int BOARD_SIZE = 10;

  @FXML
  private GridPane yourBoard;

  @FXML
  private GridPane opponentBoard;

  @FXML
  private AnchorPane mainAnchorPane;

  @FXML
  private Button eventButton;

  @FXML
  private Label winLabel;

  private int shotIndex;

  @FXML
  void initialize() {
<span class="nc" id="L61">    eventButton.addEventHandler(OpponentWithdrawEvent.OPPONENT_WITHDRAW,</span>
<span class="nc" id="L62">        opponentConnectedEvent -&gt; opponentWithdraw());</span>
<span class="nc" id="L63">    eventButton.addEventHandler(OpponentShotEvent.OPPONENT_SHOT,</span>
<span class="nc" id="L64">        opponentShotEvent -&gt; setOpponentShot(opponentShotEvent.getShotIndex()));</span>
<span class="nc" id="L65">    eventButton.addEventHandler(TurnChangeEvent.TURN_EVENT, event -&gt; setMyTurn());</span>
<span class="nc" id="L66">    eventButton.addEventHandler(MissShotEvent.MISS_SHOT, event -&gt; changeTurn());</span>
<span class="nc" id="L67">    eventButton.addEventHandler(HitShotEvent.HIT_SHOT, event -&gt; setHit());</span>
<span class="nc" id="L68">    eventButton.addEventHandler(WinEvent.GAME_WIN, event -&gt; setWin());</span>
<span class="nc" id="L69">    eventButton.addEventHandler(LooseEvent.GAME_LOSE, event -&gt; setLose());</span>

<span class="nc" id="L71">    initializeTurn(false);</span>
<span class="nc" id="L72">  }</span>

  private void initializeTurn(boolean myTurn) {
<span class="nc" id="L75">    logger.info(&quot;initialize turn: &quot; + myTurn);</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">    if (!myTurn) {</span>
<span class="nc" id="L78">      opponentBoard.setDisable(true);</span>
<span class="nc" id="L79">      final double opacity = 0.4;</span>
<span class="nc" id="L80">      opponentBoard.setOpacity(opacity);</span>
    }
<span class="nc" id="L82">  }</span>

  void initializeClient() {
<span class="nc" id="L85">    getClient().setEventTrigger(eventButton);</span>
<span class="nc" id="L86">  }</span>

  void initializeBoards(GridPane yourBoard) {
<span class="nc" id="L89">    final int margin = 50;</span>
<span class="nc" id="L90">    final NumberBinding allRectanglesWidth = Bindings.min(this.yourBoard.heightProperty(),</span>
<span class="nc" id="L91">        this.yourBoard.widthProperty().add(-margin));</span>
<span class="nc" id="L92">    final NumberBinding allRectanglesHeight = Bindings.min(this.yourBoard.heightProperty(),</span>
<span class="nc" id="L93">        this.yourBoard.widthProperty()).add(-margin);</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">    for (int i = 0; i &lt; BOARD_SIZE; i++) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">      for (int j = 0; j &lt; BOARD_SIZE; j++) {</span>
<span class="nc" id="L97">        final int shotIndex = j * BOARD_SIZE + i;</span>

<span class="nc" id="L99">        Rectangle yourRect = getYourRect(allRectanglesWidth, allRectanglesHeight);</span>
<span class="nc" id="L100">        Rectangle opponentRect = getOpponentRectangle(allRectanglesWidth,</span>
            allRectanglesHeight, shotIndex);

<span class="nc" id="L103">        this.yourBoard.add(yourRect, i, j);</span>
<span class="nc" id="L104">        opponentBoard.add(opponentRect, i, j);</span>

<span class="nc" id="L106">        GridPane.setHalignment(yourRect, HPos.CENTER);</span>
<span class="nc" id="L107">        GridPane.setHalignment(opponentRect, HPos.CENTER);</span>
      }
    }

<span class="nc" id="L111">    copyYourBoard(yourBoard);</span>
<span class="nc" id="L112">  }</span>

  private void copyYourBoard(GridPane yourBoard) {
<span class="nc bnc" id="L115" title="All 2 branches missed.">    for (int i = 1; i &lt; yourBoard.getChildren().size(); i++) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">      if (((Rectangle) yourBoard.getChildren().get(i)).getFill() == Color.GREEN) {</span>
<span class="nc" id="L117">        ((Rectangle) this.yourBoard.getChildren().get(i)).setFill(Color.GREEN);</span>
      }
    }
<span class="nc" id="L120">  }</span>

  private Client getClient() {
<span class="nc" id="L123">    MainController mainController = (MainController) mainAnchorPane.getParent().getUserData();</span>
<span class="nc" id="L124">    return mainController.getClient();</span>
  }

  private Rectangle getYourRect(NumberBinding allRectanglesWidth,
                                NumberBinding allRectanglesHeight) {
<span class="nc" id="L129">    final int initialSize = 15;</span>
<span class="nc" id="L130">    Rectangle yourRect = new Rectangle(initialSize, initialSize, Color.GRAY);</span>
<span class="nc" id="L131">    yourRect.widthProperty().bind(allRectanglesWidth.divide(BOARD_SIZE));</span>
<span class="nc" id="L132">    yourRect.heightProperty().bind(allRectanglesHeight.divide(BOARD_SIZE));</span>

<span class="nc" id="L134">    return yourRect;</span>
  }

  private Rectangle getOpponentRectangle(NumberBinding allRectanglesWidth,
                                         NumberBinding allRectanglesHeight,
                                         final int shotIndex) {
<span class="nc" id="L140">    final int initialSize = 15;</span>
<span class="nc" id="L141">    Rectangle opponentRect = new Rectangle(initialSize, initialSize, Color.GRAY);</span>

<span class="nc" id="L143">    opponentRect.setOnMouseClicked((MouseEvent mouseEvent) -&gt; {</span>
<span class="nc" id="L144">      opponentRect.setFill(Color.BLACK);</span>
<span class="nc" id="L145">      logger.info(shotIndex);</span>
<span class="nc" id="L146">      this.shotIndex = shotIndex;</span>
<span class="nc" id="L147">      getClient().sendShot(shotIndex);</span>
<span class="nc" id="L148">    });</span>

<span class="nc" id="L150">    opponentRect.widthProperty().bind(allRectanglesWidth.divide(BOARD_SIZE));</span>
<span class="nc" id="L151">    opponentRect.heightProperty().bind(allRectanglesHeight.divide(BOARD_SIZE));</span>

<span class="nc" id="L153">    return opponentRect;</span>
  }

  private void opponentWithdraw() {
<span class="nc" id="L157">    getClient().closeClient();</span>
<span class="nc" id="L158">    loadWithdrawScreen();</span>
<span class="nc" id="L159">  }</span>

  private void loadWithdrawScreen() {
    try {
<span class="nc" id="L163">      final String opponentWithdrawUrl = &quot;/fxml/opponentWithdraw.fxml&quot;;</span>
<span class="nc" id="L164">      final FXMLLoader opponentWithdrawLoader =</span>
<span class="nc" id="L165">          new FXMLLoader(getClass().getResource(opponentWithdrawUrl));</span>
<span class="nc" id="L166">      final Parent opponentWithdraw = opponentWithdrawLoader.load();</span>
<span class="nc" id="L167">      final AnchorPane mainPane = (AnchorPane) mainAnchorPane.getParent();</span>
<span class="nc" id="L168">      final int sceneHeight = 400;</span>
<span class="nc" id="L169">      final int sceneWidth = 600;</span>
<span class="nc" id="L170">      final double margin = 0.0;</span>

<span class="nc" id="L172">      Stage stage = (Stage) mainPane.getScene().getWindow();</span>
<span class="nc" id="L173">      stage.setHeight(sceneHeight);</span>
<span class="nc" id="L174">      stage.setWidth(sceneWidth);</span>

<span class="nc" id="L176">      mainPane.getChildren().clear();</span>
<span class="nc" id="L177">      mainPane.getChildren().setAll(opponentWithdraw);</span>

<span class="nc" id="L179">      AnchorPane.setTopAnchor(opponentWithdraw, margin);</span>
<span class="nc" id="L180">      AnchorPane.setBottomAnchor(opponentWithdraw, margin);</span>
<span class="nc" id="L181">      AnchorPane.setLeftAnchor(opponentWithdraw, margin);</span>
<span class="nc" id="L182">      AnchorPane.setRightAnchor(opponentWithdraw, margin);</span>

<span class="nc" id="L184">    } catch (IOException e) {</span>
<span class="nc" id="L185">      logger.error(e.getMessage());</span>
<span class="nc" id="L186">    }</span>
<span class="nc" id="L187">  }</span>

  private void setOpponentShot(int shotIndex) {
<span class="nc" id="L190">    int column = shotIndex / BOARD_SIZE;</span>
<span class="nc" id="L191">    int row = shotIndex - (column * BOARD_SIZE);</span>
<span class="nc" id="L192">    int newShotIndex = row * BOARD_SIZE + column;</span>
<span class="nc" id="L193">    logger.info(&quot;new shotIndex: &quot; + newShotIndex);</span>
<span class="nc" id="L194">    Rectangle rec = (Rectangle) (yourBoard.getChildren().get(newShotIndex + 1));</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (rec.getFill() == Color.GREEN) {</span>
<span class="nc" id="L196">      rec.setFill(Color.RED);</span>
    } else {
<span class="nc" id="L198">      rec.setFill(Color.BLACK);</span>
    }
<span class="nc" id="L200">  }</span>

  private void changeTurn() {
<span class="nc" id="L203">    final double opacity = 0.4;</span>
<span class="nc" id="L204">    opponentBoard.setDisable(true);</span>
<span class="nc" id="L205">    opponentBoard.setOpacity(opacity);</span>
<span class="nc" id="L206">  }</span>

  private void setHit() {
<span class="nc" id="L209">    int column = shotIndex / BOARD_SIZE;</span>
<span class="nc" id="L210">    int row = shotIndex - (column * BOARD_SIZE);</span>
<span class="nc" id="L211">    int newShotIndex = row * BOARD_SIZE + column;</span>
<span class="nc" id="L212">    Rectangle rec = (Rectangle) (opponentBoard.getChildren().get(newShotIndex + 1));</span>
<span class="nc" id="L213">    rec.setFill(Color.RED);</span>
<span class="nc" id="L214">  }</span>

  private void setMyTurn() {
<span class="nc" id="L217">    logger.info(&quot;set my turn game controller&quot;);</span>
<span class="nc" id="L218">    final double noOpacity = 1.0;</span>
<span class="nc" id="L219">    opponentBoard.setDisable(false);</span>
<span class="nc" id="L220">    opponentBoard.setOpacity(noOpacity);</span>
<span class="nc" id="L221">  }</span>

  private void setWin() {
<span class="nc" id="L224">    getClient().closeClient();</span>
<span class="nc" id="L225">    eventButton.removeEventHandler(OpponentWithdrawEvent.OPPONENT_WITHDRAW,</span>
<span class="nc" id="L226">        opponentConnectedEvent -&gt; opponentWithdraw());</span>
<span class="nc" id="L227">    winLabel.setStyle(&quot;-fx-color: green&quot;);</span>
<span class="nc" id="L228">    winLabel.setText(&quot;YOU WIN!&quot;);</span>
<span class="nc" id="L229">    final double opacity = 0.4;</span>
<span class="nc" id="L230">    yourBoard.setDisable(true);</span>
<span class="nc" id="L231">    yourBoard.setOpacity(opacity);</span>
<span class="nc" id="L232">    opponentBoard.setDisable(true);</span>
<span class="nc" id="L233">    opponentBoard.setOpacity(opacity);</span>
<span class="nc" id="L234">  }</span>

  private void setLose() {
<span class="nc" id="L237">    getClient().closeClient();</span>
<span class="nc" id="L238">    eventButton.removeEventHandler(OpponentWithdrawEvent.OPPONENT_WITHDRAW,</span>
<span class="nc" id="L239">        opponentConnectedEvent -&gt; opponentWithdraw());</span>
<span class="nc" id="L240">    winLabel.setStyle(&quot;-fx-color: green&quot;);</span>
<span class="nc" id="L241">    winLabel.setText(&quot;YOU LOSE!&quot;);</span>
<span class="nc" id="L242">    final double opacity = 0.4;</span>
<span class="nc" id="L243">    yourBoard.setDisable(true);</span>
<span class="nc" id="L244">    yourBoard.setOpacity(opacity);</span>
<span class="nc" id="L245">    opponentBoard.setDisable(true);</span>
<span class="nc" id="L246">    opponentBoard.setOpacity(opacity);</span>
<span class="nc" id="L247">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>