<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameWindowController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ships - CLIENT</a> &gt; <a href="index.source.html" class="el_package">pl.korotkevics.ships.client.gui.controllers</a> &gt; <span class="el_source">GameWindowController.java</span></div><h1>GameWindowController.java</h1><pre class="source lang-java linenums">package pl.korotkevics.ships.client.gui.controllers;

import javafx.application.Platform;
import javafx.beans.binding.Bindings;
import javafx.beans.binding.NumberBinding;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.geometry.HPos;
import javafx.scene.Parent;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.StackPane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.stage.Stage;
import pl.korotkevics.ships.client.client.Client;
import pl.korotkevics.ships.client.gui.events.HitShotEvent;
import pl.korotkevics.ships.client.gui.events.LossEvent;
import pl.korotkevics.ships.client.gui.events.MissShotEvent;
import pl.korotkevics.ships.client.gui.events.OpponentShotEvent;
import pl.korotkevics.ships.client.gui.events.OpponentWithdrawEvent;
import pl.korotkevics.ships.client.gui.events.ShipDestroyedEvent;
import pl.korotkevics.ships.client.gui.events.TurnChangeEvent;
import pl.korotkevics.ships.client.gui.events.WinEvent;
import pl.korotkevics.ships.client.gui.util.GridToBoardConverter;
import pl.korotkevics.ships.shared.infra.logging.api.Target;
import pl.korotkevics.ships.shared.infra.logging.core.SharedLogger;

import java.io.IOException;
import java.net.URL;
import java.util.ResourceBundle;
import java.util.Set;

/**
 * Game window controller.
 *
 * @author Magdalena Aarsman
 * @since 2017-12-15
 */

<span class="nc" id="L45">public class GameWindowController implements Initializable {</span>

<span class="nc" id="L47">  private static final Target logger = new SharedLogger(Client.class);</span>

  private static final int BOARD_SIZE = 10;

  @FXML
  private GridPane yourBoard;

  @FXML
  private GridPane opponentBoard;

  @FXML
  private AnchorPane mainAnchorPane;

  @FXML
  private Button eventButton;

  @FXML
  private Label winLabel;

  @FXML
  private StackPane endStack;

  @FXML
  private Button buttonEnd;

  @FXML
  private Label infoLabel;

  private int shotIndex;
  private ResourceBundle resourceBundle;
  private boolean hitShot;
  private boolean shipDestroyed;

  private void initializeTurn(final boolean myTurn) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">    if (!myTurn) {</span>
<span class="nc" id="L82">      opponentBoard.setDisable(true);</span>
<span class="nc" id="L83">      final double opacity = 0.4;</span>
<span class="nc" id="L84">      opponentBoard.setOpacity(opacity);</span>
    }
<span class="nc" id="L86">  }</span>

  void initializeClient() {
<span class="nc" id="L89">    getClient().setEventTrigger(eventButton);</span>
<span class="nc" id="L90">  }</span>

  void initializeBoards(GridPane yourBoard) {
<span class="nc" id="L93">    final int margin = 50;</span>
<span class="nc" id="L94">    final NumberBinding allRectanglesWidth = Bindings.min(this.yourBoard.heightProperty(),</span>
<span class="nc" id="L95">        this.yourBoard.widthProperty().add(-margin));</span>
<span class="nc" id="L96">    final NumberBinding allRectanglesHeight = Bindings.min(this.yourBoard.heightProperty(),</span>
<span class="nc" id="L97">        this.yourBoard.widthProperty()).add(-margin);</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">    for (int i = 0; i &lt; BOARD_SIZE; i++) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">      for (int j = 0; j &lt; BOARD_SIZE; j++) {</span>
<span class="nc" id="L101">        final int shotIndex = j * BOARD_SIZE + i;</span>

<span class="nc" id="L103">        Rectangle yourRect = getYourRect(allRectanglesWidth, allRectanglesHeight);</span>
<span class="nc" id="L104">        Rectangle opponentRect = getOpponentRectangle(allRectanglesWidth,</span>
            allRectanglesHeight, shotIndex);

<span class="nc" id="L107">        this.yourBoard.add(yourRect, i, j);</span>
<span class="nc" id="L108">        opponentBoard.add(opponentRect, i, j);</span>

<span class="nc" id="L110">        GridPane.setHalignment(yourRect, HPos.CENTER);</span>
<span class="nc" id="L111">        GridPane.setHalignment(opponentRect, HPos.CENTER);</span>
      }
    }

<span class="nc" id="L115">    copyYourBoard(yourBoard);</span>
<span class="nc" id="L116">  }</span>

  private void copyYourBoard(GridPane yourBoard) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">    for (int i = 1; i &lt; yourBoard.getChildren().size(); i++) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">      if (((Rectangle) yourBoard.getChildren().get(i)).getFill() == Color.GREEN) {</span>
<span class="nc" id="L121">        ((Rectangle) this.yourBoard.getChildren().get(i)).setFill(Color.GREEN);</span>
      }
    }
<span class="nc" id="L124">  }</span>

  private Client getClient() {
<span class="nc" id="L127">    MainController mainController = (MainController) mainAnchorPane.getParent().getUserData();</span>
<span class="nc" id="L128">    return mainController.getClient();</span>
  }

  private Rectangle getYourRect(NumberBinding allRectanglesWidth,
                                NumberBinding allRectanglesHeight) {
<span class="nc" id="L133">    final int initialSize = 15;</span>
<span class="nc" id="L134">    Rectangle yourRect = new Rectangle(initialSize, initialSize, Color.GRAY);</span>
<span class="nc" id="L135">    yourRect.widthProperty().bind(allRectanglesWidth.divide(BOARD_SIZE));</span>
<span class="nc" id="L136">    yourRect.heightProperty().bind(allRectanglesHeight.divide(BOARD_SIZE));</span>

<span class="nc" id="L138">    return yourRect;</span>
  }

  private Rectangle getOpponentRectangle(NumberBinding allRectanglesWidth,
                                         NumberBinding allRectanglesHeight,
                                         final int shotIndex) {
<span class="nc" id="L144">    final int initialSize = 15;</span>
<span class="nc" id="L145">    Rectangle opponentRect = new Rectangle(initialSize, initialSize, Color.GRAY);</span>

<span class="nc" id="L147">    opponentRect.setOnMouseClicked((MouseEvent mouseEvent) -&gt; {</span>
<span class="nc" id="L148">      opponentBoard.setDisable(true);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">      if (opponentRect.getFill().equals(Color.GRAY)) {</span>
<span class="nc" id="L150">        opponentRect.setFill(Color.BLACK);</span>
      }
<span class="nc" id="L152">      this.shotIndex = shotIndex;</span>
<span class="nc" id="L153">      getClient().sendShot(shotIndex);</span>
<span class="nc" id="L154">    });</span>

<span class="nc" id="L156">    opponentRect.widthProperty().bind(allRectanglesWidth.divide(BOARD_SIZE));</span>
<span class="nc" id="L157">    opponentRect.heightProperty().bind(allRectanglesHeight.divide(BOARD_SIZE));</span>

<span class="nc" id="L159">    return opponentRect;</span>
  }

  private void opponentWithdraw() {
<span class="nc" id="L163">    getClient().closeClient();</span>
<span class="nc" id="L164">    loadWithdrawScreen();</span>
<span class="nc" id="L165">  }</span>

  private void loadWithdrawScreen() {
    try {
<span class="nc" id="L169">      final String opponentWithdrawUrl = &quot;/fxml/opponentWithdraw.fxml&quot;;</span>
<span class="nc" id="L170">      final FXMLLoader opponentWithdrawLoader =</span>
<span class="nc" id="L171">          new FXMLLoader(getClass().getResource(opponentWithdrawUrl));</span>
<span class="nc" id="L172">      opponentWithdrawLoader.setResources(this.resourceBundle);</span>
<span class="nc" id="L173">      final Parent opponentWithdraw = opponentWithdrawLoader.load();</span>
<span class="nc" id="L174">      final AnchorPane mainPane = (AnchorPane) mainAnchorPane.getParent();</span>
<span class="nc" id="L175">      final int sceneHeight = 400;</span>
<span class="nc" id="L176">      final int sceneWidth = 600;</span>
<span class="nc" id="L177">      final double margin = 0.0;</span>

<span class="nc" id="L179">      Stage stage = (Stage) mainPane.getScene().getWindow();</span>
<span class="nc" id="L180">      stage.setHeight(sceneHeight);</span>
<span class="nc" id="L181">      stage.setWidth(sceneWidth);</span>

<span class="nc" id="L183">      mainPane.getChildren().clear();</span>
<span class="nc" id="L184">      mainPane.getChildren().setAll(opponentWithdraw);</span>

<span class="nc" id="L186">      AnchorPane.setTopAnchor(opponentWithdraw, margin);</span>
<span class="nc" id="L187">      AnchorPane.setBottomAnchor(opponentWithdraw, margin);</span>
<span class="nc" id="L188">      AnchorPane.setLeftAnchor(opponentWithdraw, margin);</span>
<span class="nc" id="L189">      AnchorPane.setRightAnchor(opponentWithdraw, margin);</span>

<span class="nc" id="L191">    } catch (IOException e) {</span>
<span class="nc" id="L192">      logger.error(e.getMessage());</span>
<span class="nc" id="L193">    }</span>
<span class="nc" id="L194">  }</span>

  private void setOpponentShot(final int shotIndex) {
<span class="nc" id="L197">    final int shotIndexInGrid = convertToGridIndex(shotIndex);</span>
<span class="nc" id="L198">    final Rectangle rec = (Rectangle) (yourBoard.getChildren().get(shotIndexInGrid));</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">    if (rec.getFill() == Color.GREEN) {</span>
<span class="nc" id="L200">      rec.setFill(Color.RED);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">    } else if (rec.getFill().equals(Color.GRAY)) {</span>
<span class="nc" id="L202">      rec.setFill(Color.BLACK);</span>
    }
<span class="nc" id="L204">  }</span>

  private int convertToGridIndex(final int shotIndex) {
<span class="nc" id="L207">    final int column = shotIndex / BOARD_SIZE;</span>
<span class="nc" id="L208">    final int row = shotIndex - (column * BOARD_SIZE);</span>
<span class="nc" id="L209">    return row * BOARD_SIZE + column + 1;</span>
  }

  private void changeTurn() {
<span class="nc" id="L213">    final double opacity = 0.4;</span>
<span class="nc" id="L214">    this.opponentBoard.setDisable(true);</span>
<span class="nc" id="L215">    this.opponentBoard.setOpacity(opacity);</span>
<span class="nc" id="L216">    this.infoLabel.setText(this.resourceBundle.getString(&quot;youMiss&quot;)</span>
        + &quot; &quot;
<span class="nc" id="L218">        + this.resourceBundle.getString(&quot;opponentAction&quot;));</span>
<span class="nc" id="L219">  }</span>

  private void markAsHit() {
<span class="nc" id="L222">    final int shotIndexInGrid = this.convertToGridIndex(shotIndex);</span>
<span class="nc" id="L223">    final Rectangle rec = (Rectangle) (opponentBoard.getChildren().get(shotIndexInGrid));</span>
<span class="nc" id="L224">    rec.setFill(Color.RED);</span>
<span class="nc" id="L225">    this.hitShot = true;</span>
<span class="nc" id="L226">  }</span>

  private void setMyTurn() {
<span class="nc" id="L229">    final double noOpacity = 1.0;</span>
<span class="nc" id="L230">    opponentBoard.setDisable(false);</span>
<span class="nc" id="L231">    opponentBoard.setOpacity(noOpacity);</span>
<span class="nc" id="L232">    this.infoLabel.setText(this.resourceBundle.getString(&quot;yourTurn&quot;));</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">    if (this.hitShot) {</span>
<span class="nc" id="L234">      this.infoLabel.setText(this.infoLabel.getText()</span>
          + &quot; &quot;
<span class="nc" id="L236">          + this.resourceBundle.getString(&quot;youHit&quot;));</span>
<span class="nc" id="L237">      this.hitShot = false;</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">    } else if (this.shipDestroyed) {</span>
<span class="nc" id="L239">      this.infoLabel.setText(this.infoLabel.getText()</span>
          + &quot; &quot;
<span class="nc" id="L241">          + this.resourceBundle.getString(&quot;shipDestroyed&quot;));</span>
<span class="nc" id="L242">      this.shipDestroyed = false;</span>
    }
<span class="nc" id="L244">  }</span>

  @Override
  public void initialize(final URL location, final ResourceBundle resources) {
<span class="nc" id="L248">    this.resourceBundle = resources;</span>
<span class="nc" id="L249">    eventButton.addEventHandler(OpponentWithdrawEvent.OPPONENT_WITHDRAW,</span>
<span class="nc" id="L250">        opponentConnectedEvent -&gt; opponentWithdraw());</span>
<span class="nc" id="L251">    eventButton.addEventHandler(OpponentShotEvent.OPPONENT_SHOT,</span>
<span class="nc" id="L252">        opponentShotEvent -&gt; setOpponentShot(opponentShotEvent.getShotIndex()));</span>
<span class="nc" id="L253">    eventButton.addEventHandler(TurnChangeEvent.TURN_EVENT, event -&gt; setMyTurn());</span>
<span class="nc" id="L254">    eventButton.addEventHandler(MissShotEvent.MISS_SHOT, event -&gt; changeTurn());</span>
<span class="nc" id="L255">    eventButton.addEventHandler(HitShotEvent.HIT_SHOT, event -&gt; markAsHit());</span>
<span class="nc" id="L256">    eventButton.addEventHandler(WinEvent.GAME_WIN, event -&gt; renderAsWin());</span>
<span class="nc" id="L257">    eventButton.addEventHandler(LossEvent.GAME_LOSS, event -&gt; renderAsLoss());</span>
<span class="nc" id="L258">    eventButton.addEventHandler(ShipDestroyedEvent.SHIP_DESTROYED, event -&gt; this.shipDestroyed());</span>
<span class="nc" id="L259">    buttonEnd.setOnAction(actionEvent -&gt; this.endTheGame());</span>
<span class="nc" id="L260">    infoLabel.setText(this.resourceBundle.getString(&quot;opponentAction&quot;));</span>
<span class="nc" id="L261">    initializeTurn(false);</span>
<span class="nc" id="L262">  }</span>

  private void shipDestroyed() {
<span class="nc" id="L265">    final int shotIndexInGrid = this.convertToGridIndex(shotIndex);</span>
<span class="nc" id="L266">    final Rectangle rec = (Rectangle) (opponentBoard.getChildren().get(shotIndexInGrid));</span>
<span class="nc" id="L267">    rec.setFill(Color.RED);</span>
<span class="nc" id="L268">    shipDestroyed = true;</span>
<span class="nc" id="L269">    SunkenShipMarker shipDestroyer =</span>
<span class="nc" id="L270">        new SunkenShipMarker(new GridToBoardConverter(opponentBoard).convert(), shotIndexInGrid - 1);</span>
<span class="nc" id="L271">    this.destroyShip(shipDestroyer.getIndexToColor());</span>
<span class="nc" id="L272">  }</span>

  private void endTheGame() {
<span class="nc" id="L275">    Platform.exit();</span>
<span class="nc" id="L276">  }</span>

  private void renderAsWin() {
<span class="nc" id="L279">    this.prepareToRenderAnyPossibleResult();</span>
<span class="nc" id="L280">    this.renderSpecificResult(&quot;youWin&quot;);</span>
<span class="nc" id="L281">    this.endStack.setVisible(true);</span>
<span class="nc" id="L282">    this.buttonEnd.setDisable(false);</span>
<span class="nc" id="L283">  }</span>

  private void renderAsLoss() {
<span class="nc" id="L286">    this.prepareToRenderAnyPossibleResult();</span>
<span class="nc" id="L287">    this.renderSpecificResult(&quot;youLose&quot;);</span>
<span class="nc" id="L288">    this.endStack.setVisible(true);</span>
<span class="nc" id="L289">    this.buttonEnd.setDisable(false);</span>
<span class="nc" id="L290">  }</span>

  private void renderSpecificResult(String key) {
<span class="nc" id="L293">    this.winLabel.setText(this.resourceBundle.getString(key));</span>
<span class="nc" id="L294">  }</span>

  private void prepareToRenderAnyPossibleResult() {
<span class="nc" id="L297">    this.disableWithdrawalPossibility();</span>
<span class="nc" id="L298">    this.disableBoards();</span>
<span class="nc" id="L299">    this.infoLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L300">  }</span>

  private void disableBoards() {
<span class="nc" id="L303">    final double opacity = 0.4;</span>
<span class="nc" id="L304">    this.yourBoard.setDisable(true);</span>
<span class="nc" id="L305">    this.yourBoard.setOpacity(opacity);</span>
<span class="nc" id="L306">    this.opponentBoard.setDisable(true);</span>
<span class="nc" id="L307">    this.opponentBoard.setOpacity(opacity);</span>
<span class="nc" id="L308">    this.winLabel.setStyle(&quot;-fx-color: green&quot;);</span>
<span class="nc" id="L309">  }</span>

  private void disableWithdrawalPossibility() {
<span class="nc" id="L312">    this.eventButton.removeEventHandler(OpponentWithdrawEvent.OPPONENT_WITHDRAW,</span>
<span class="nc" id="L313">        opponentConnectedEvent -&gt; opponentWithdraw());</span>
<span class="nc" id="L314">  }</span>

  private void destroyShip(Set&lt;Integer&gt; indexes){
<span class="nc" id="L317">    indexes.forEach(i -&gt; ((Rectangle )this.opponentBoard.getChildren().get(i + 1)).setFill(Color.BLACK));</span>
<span class="nc" id="L318">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>